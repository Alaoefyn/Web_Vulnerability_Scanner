from flask import Blueprint, render_template, request, redirect, url_for
from flask_login import login_required, current_user
from .models import ScanResult
from . import db
from .scanner import scan_website

main = Blueprint('main', __name__)

@main.route('/')
@login_required
def index():
    return render_template('scan.html')

@main.route('/scan', methods=['POST'])
@login_required
def scan_url():
    url = request.form.get('url')
    if url:
        vulnerabilities = scan_website(url)
        vulnerabilities_str = '\n'.join(vulnerabilities)
        new_scan = ScanResult(url=url, vulnerabilities=vulnerabilities_str, user_id=current_user.id)
        db.session.add(new_scan)
        db.session.commit()
        return redirect(url_for('main.results'))
    return redirect(url_for('main.index'))

@main.route('/results')
@login_required
def results():
    scan_results = ScanResult.query.filter_by(user_id=current_user.id).order_by(ScanResult.scan_date.desc()).all()
    return render_template('results.html', scan_results=scan_results)
